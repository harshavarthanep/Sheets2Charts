<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataViz Pro | Multi-Series Analytics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Core Theme --- */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Glass & Components */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .chart-container { position: relative; height: 60vh; min-height: 450px; width: 100%; }

        /* Custom Multi-Select Dropdown */
        .multi-select-dropdown {
            display: none;
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            margin-top: 4px;
        }
        .multi-select-dropdown.active { display: block; }
        
        .checkbox-item {
            display: flex; align-items: center; padding: 8px 12px;
            cursor: pointer; transition: background 0.2s; font-size: 0.85rem;
        }
        .checkbox-item:hover { background: #334155; }
        .checkbox-item input { margin-right: 10px; accent-color: #3b82f6; }

        /* Loading Spinner */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Chips for selected items */
        .chip { background: #334155; padding: 2px 8px; border-radius: 4px; font-size: 10px; display: inline-flex; align-items: center; gap: 4px; border: 1px solid #475569; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900/90 backdrop-blur border-b border-slate-700 h-16 flex items-center justify-between px-6 sticky top-0 z-[40] shadow-lg shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white w-9 h-9 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/20">
                <i class="fa-solid fa-chart-line"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white leading-tight">DataViz <span class="text-blue-500">Pro</span></h1>
                <p class="text-[10px] text-slate-400 font-mono">SECURE • LOCAL • PERSISTENT</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div id="save-status" class="text-xs text-emerald-500 font-mono hidden md:block transition-opacity duration-500 opacity-0">Saved locally</div>

            <button onclick="clearAllData()" class="text-slate-400 hover:text-red-400 text-xs flex items-center gap-2 transition px-3 py-1.5 rounded hover:bg-slate-800" title="Clear all saved data">
                <i class="fa-solid fa-trash-can"></i> <span class="hidden sm:inline">Reset App</span>
            </button>

            <input type="file" id="global-file-input" multiple accept=".xlsx, .xls, .csv" class="hidden">
            
            <button onclick="triggerUpload()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-blue-600/20 transition flex items-center gap-2 border border-blue-500">
                <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">Import Data</span>
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row h-[calc(100vh-64px)] overflow-hidden">
        
        <aside class="w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-30 shrink-0 h-full overflow-y-auto">
            <div class="p-4 space-y-6">
                
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase mb-2 block tracking-wider">Active Dataset</label>
                    <select id="s-file" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"></select>
                </div>

                <div class="border-t border-slate-800 my-2"></div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-blue-400 font-bold uppercase mb-1.5 block tracking-wider"><i class="fa-solid fa-arrows-left-right mr-1"></i> X-Axis (Category)</label>
                        <select id="s-xaxis" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500"></select>
                    </div>

                    <div class="relative">
                        <label class="text-[10px] text-emerald-400 font-bold uppercase mb-1.5 flex justify-between tracking-wider">
                            <span><i class="fa-solid fa-arrows-up-down mr-1"></i> Y-Axis (Values)</span>
                            <span id="y-count" class="text-slate-500 text-[9px] bg-slate-800 px-1.5 rounded">0 selected</span>
                        </label>
                        
                        <button id="y-select-btn" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-left text-slate-300 outline-none focus:border-emerald-500 flex justify-between items-center relative">
                            <span class="truncate">Select Columns...</span>
                            <i class="fa-solid fa-chevron-down text-xs text-slate-500"></i>
                        </button>
                        
                        <div id="y-dropdown" class="multi-select-dropdown">
                            <div class="p-2 border-b border-slate-700 flex justify-between">
                                <button onclick="toggleAllY(true)" class="text-[10px] text-blue-400 hover:text-white">Select All</button>
                                <button onclick="toggleAllY(false)" class="text-[10px] text-slate-500 hover:text-white">Clear</button>
                            </div>
                            <div id="y-options-list"></div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-800 my-2"></div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1.5 block tracking-wider">Chart Type</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setChartType('bar')" class="type-btn active bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="bar"><i class="fa-solid fa-chart-column text-blue-500"></i></button>
                            <button onclick="setChartType('line')" class="type-btn bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="line"><i class="fa-solid fa-chart-line text-emerald-500"></i></button>
                            <button onclick="setChartType('pie')" class="type-btn bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="pie"><i class="fa-solid fa-chart-pie text-purple-500"></i></button>
                            <button onclick="setChartType('doughnut')" class="type-btn bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="doughnut"><i class="fa-regular fa-circle text-orange-500"></i></button>
                            <button onclick="setChartType('radar')" class="type-btn bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="radar"><i class="fa-solid fa-bullseye text-red-500"></i></button>
                            <button onclick="setChartType('scatter')" class="type-btn bg-slate-800 border border-slate-700 rounded p-2 text-center hover:bg-slate-700 transition" data-type="scatter"><i class="fa-solid fa-braille text-cyan-500"></i></button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center justify-between cursor-pointer p-2 rounded hover:bg-slate-800 border border-transparent hover:border-slate-700 transition">
                            <span class="text-xs text-slate-300">Show Data Labels</span>
                            <input type="checkbox" id="toggle-labels" class="accent-blue-600" onchange="updateChart()">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer p-2 rounded hover:bg-slate-800 border border-transparent hover:border-slate-700 transition">
                            <span class="text-xs text-slate-300">Stack Bars</span>
                            <input type="checkbox" id="toggle-stack" class="accent-blue-600" onchange="updateChart()">
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="mt-auto p-4 border-t border-slate-800">
                <button onclick="downloadChart()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded border border-slate-600 text-xs font-bold uppercase transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> Export PNG
                </button>
            </div>
        </aside>

        <section class="flex-grow flex flex-col h-full overflow-hidden bg-slate-950/50 relative">
            
            <div class="flex-grow p-4 md:p-6 overflow-hidden flex flex-col">
                <div class="glass-panel w-full h-full rounded-xl p-4 relative shadow-2xl flex flex-col">
                    <div class="flex justify-between items-start mb-2 shrink-0">
                        <div>
                            <h2 id="chart-title" class="text-lg font-bold text-white">Analytics Overview</h2>
                            <p id="chart-subtitle" class="text-xs text-slate-400">Select data to visualize</p>
                        </div>
                        <div class="flex gap-2">
                             <div class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400 border border-slate-700">
                                <i class="fa-solid fa-calculator mr-1"></i> Auto-Aggregated
                             </div>
                        </div>
                    </div>
                    
                    <div class="relative flex-grow min-h-0 w-full">
                        <canvas id="main-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="shrink-0 bg-slate-900 border-t border-slate-800">
                 <button onclick="toggleTable()" class="w-full py-1 text-[10px] text-slate-500 hover:text-slate-300 flex justify-center items-center gap-1 hover:bg-slate-800 transition">
                    <i class="fa-solid fa-table"></i> Toggle Data View
                </button>
            </div>

            <div id="table-panel" class="h-0 transition-all duration-300 bg-slate-900 overflow-hidden flex flex-col border-t border-slate-800">
                <div class="p-2 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-2">Source Data Preview</span>
                    <span id="row-count" class="text-[10px] font-mono text-slate-500"></span>
                </div>
                <div class="overflow-auto flex-grow">
                    <table class="w-full text-left text-xs text-slate-400 whitespace-nowrap">
                        <thead class="bg-slate-900 sticky top-0 z-10 text-slate-200">
                            <tr id="table-head"></tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <div id="welcome-modal" class="fixed inset-0 bg-slate-950/90 z-[100] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-blue-500 blur-[20px]"></div>

            <div class="w-16 h-16 bg-gradient-to-tr from-slate-800 to-slate-700 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner border border-slate-600">
                <i class="fa-solid fa-layer-group text-3xl text-blue-400"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-2">Welcome Back</h2>
            <p id="welcome-text" class="text-slate-400 mb-8 text-sm leading-relaxed">
                Secure, server-free analytics. <br>Your data never leaves this browser.
            </p>

            <div id="restore-section" class="hidden mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50 text-left">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <p class="text-xs text-slate-300 font-medium">Previous session found</p>
                </div>
                <button onclick="restoreSession()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2.5 rounded-lg font-bold text-sm transition shadow-lg shadow-emerald-900/20">
                    Resume Dashboard
                </button>
            </div>

            <button onclick="triggerUpload()" class="w-full bg-blue-600 hover:bg-blue-500 text-white px-6 py-3.5 rounded-xl font-bold transition shadow-xl shadow-blue-900/20 flex items-center justify-center gap-2 group">
                <i class="fa-solid fa-plus group-hover:scale-110 transition-transform"></i> Create New Analysis
            </button>
            
            <p class="mt-4 text-[10px] text-slate-600">Supports .xlsx, .xls, .csv</p>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & UTILS ---
        Chart.register(ChartDataLabels);
        
        const COLORS = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
        ];

        // --- 2. INDEXED DB (Persistence Layer) ---
        const DB_NAME = 'DataVizPro_DB';
        const dbPromise = new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 2); // Bump version
            req.onupgradeneeded = (e) => e.target.result.createObjectStore('files');
            req.onsuccess = (e) => resolve(e.target.result);
            req.onerror = reject;
        });

        async function dbOp(type, key, val) {
            const db = await dbPromise;
            return new Promise((resolve) => {
                const tx = db.transaction('files', type === 'get' ? 'readonly' : 'readwrite');
                const store = tx.objectStore('files');
                const req = type === 'put' ? store.put(val, key) : type === 'get' ? store.get(key) : store.clear();
                req.onsuccess = () => resolve(req.result);
                tx.oncomplete = () => resolve();
            });
        }

        // --- 3. STATE MANAGEMENT ---
        const App = {
            files: {},
            activeFile: null,
            config: {
                xKey: null,
                yKeys: [], // Array for Multi-Series
                type: 'bar',
                showLabels: false,
                stack: false
            },
            chartInstance: null
        };

        const els = {
            input: document.getElementById('global-file-input'),
            modal: document.getElementById('welcome-modal'),
            fileSelect: document.getElementById('s-file'),
            xSelect: document.getElementById('s-xaxis'),
            yBtn: document.getElementById('y-select-btn'),
            yDropdown: document.getElementById('y-dropdown'),
            yList: document.getElementById('y-options-list'),
            saveStatus: document.getElementById('save-status'),
            tablePanel: document.getElementById('table-panel')
        };

        // --- 4. INITIALIZATION ---
        (async function init() {
            const savedState = await dbOp('get', 'appState');
            if(savedState && savedState.files && Object.keys(savedState.files).length > 0) {
                document.getElementById('restore-section').classList.remove('hidden');
                document.getElementById('welcome-text').innerText = `Ready to resume with ${Object.keys(savedState.files).length} datasets.`;
            }
        })();

        async function restoreSession() {
            const saved = await dbOp('get', 'appState');
            if(saved) {
                App.files = saved.files;
                App.activeFile = saved.activeFile || Object.keys(App.files)[0];
                App.config = saved.config || App.config;
                els.modal.style.display = 'none';
                renderUI();
            }
        }

        // --- 5. DATA INGESTION ---
        function triggerUpload() { els.input.click(); }
        
        els.input.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            els.modal.style.display = 'none';

            for(const f of files) {
                const data = await f.arrayBuffer();
                const wb = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: 0 }); // defval 0 helps charts
                
                if(json.length) {
                    const headers = Object.keys(json[0]);
                    App.files[f.name] = { data: json, headers: headers };
                    App.activeFile = f.name;
                    
                    // Auto-Guess Config
                    App.config.xKey = headers.find(h => /date|month|year|name|region/i.test(h)) || headers[0];
                    // Find all number columns for Y
                    const numberCols = headers.filter(h => typeof json[0][h] === 'number');
                    App.config.yKeys = numberCols.length > 0 ? [numberCols[0]] : [headers[1]];
                }
            }
            renderUI();
            saveState();
        });

        // --- 6. UI RENDERING ---
        function renderUI() {
            if(!App.activeFile) return;
            const f = App.files[App.activeFile];

            // 1. Populate File Select
            els.fileSelect.innerHTML = Object.keys(App.files).map(n => `<option value="${n}">${n}</option>`).join('');
            els.fileSelect.value = App.activeFile;

            // 2. Populate X-Axis
            els.xSelect.innerHTML = f.headers.map(h => `<option value="${h}">${h}</option>`).join('');
            els.xSelect.value = App.config.xKey;

            // 3. Populate Y-Axis (Multi-Select)
            renderYDropdown(f.headers);

            // 4. Update Chart Type Buttons
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.toggle('bg-blue-600', b.dataset.type === App.config.type);
                b.classList.toggle('text-white', b.dataset.type === App.config.type);
                if(b.dataset.type !== App.config.type) b.classList.add('bg-slate-800');
            });
            
            // 5. Update Toggles
            document.getElementById('toggle-labels').checked = App.config.showLabels;
            document.getElementById('toggle-stack').checked = App.config.stack;

            // 6. Render Components
            updateChart();
            renderTable();
        }

        function renderYDropdown(headers) {
            els.yList.innerHTML = headers.map(h => `
                <label class="checkbox-item text-slate-300">
                    <input type="checkbox" value="${h}" 
                        ${App.config.yKeys.includes(h) ? 'checked' : ''} 
                        onchange="toggleYKey('${h}')">
                    <span class="truncate">${h}</span>
                </label>
            `).join('');
            updateYButtonLabel();
        }

        // --- 7. INTERACTION LOGIC ---
        els.fileSelect.addEventListener('change', (e) => { App.activeFile = e.target.value; renderUI(); saveState(); });
        els.xSelect.addEventListener('change', (e) => { App.config.xKey = e.target.value; updateChart(); saveState(); });

        // Y-Axis Custom Logic
        els.yBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            els.yDropdown.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if(!els.yDropdown.contains(e.target) && !els.yBtn.contains(e.target)) {
                els.yDropdown.classList.remove('active');
            }
        });

        window.toggleYKey = (key) => {
            if(App.config.yKeys.includes(key)) {
                App.config.yKeys = App.config.yKeys.filter(k => k !== key);
            } else {
                App.config.yKeys.push(key);
            }
            updateYButtonLabel();
            updateChart();
            saveState();
        };

        window.toggleAllY = (select) => {
            const f = App.files[App.activeFile];
            App.config.yKeys = select ? [...f.headers] : [];
            renderYDropdown(f.headers);
            updateChart();
            saveState();
        };

        function updateYButtonLabel() {
            const count = App.config.yKeys.length;
            document.getElementById('y-count').innerText = `${count} selected`;
            els.yBtn.querySelector('span').innerText = count === 0 ? "Select Columns..." : 
                count === 1 ? App.config.yKeys[0] : `${App.config.yKeys[0]} + ${count-1} more`;
        }

        window.setChartType = (t) => { App.config.type = t; renderUI(); saveState(); };

        // --- 8. CHART ENGINE (The Brain) ---
        function updateChart() {
            const ctx = document.getElementById('main-chart').getContext('2d');
            const f = App.files[App.activeFile];
            
            // 1. Pivot / Aggregate Data (Excel Pivot Logic)
            const groupedData = {};
            f.data.forEach(row => {
                const xVal = row[App.config.xKey];
                if(!groupedData[xVal]) groupedData[xVal] = { _count: 0 };
                
                App.config.yKeys.forEach(yk => {
                    // Clean number (remove $ or ,)
                    let val = row[yk];
                    if(typeof val === 'string') val = parseFloat(val.replace(/[^0-9.-]+/g,""));
                    if(isNaN(val)) val = 0;
                    
                    groupedData[xVal][yk] = (groupedData[xVal][yk] || 0) + val;
                });
                groupedData[xVal]._count++;
            });

            const labels = Object.keys(groupedData);
            
            // 2. Build Datasets
            const datasets = App.config.yKeys.map((yk, index) => {
                const color = COLORS[index % COLORS.length];
                const data = labels.map(l => groupedData[l][yk]); // Sum
                
                return {
                    label: yk,
                    data: data,
                    backgroundColor: App.config.type === 'line' ? color + '20' : color + 'CC', // Transparent for line
                    borderColor: color,
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3,
                    fill: App.config.type === 'line' || App.config.type === 'radar'
                };
            });

            // 3. Destroy & Recreate
            if(App.chartInstance) App.chartInstance.destroy();

            App.chartInstance = new Chart(ctx, {
                type: App.config.type,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8', font: {size: 11} } },
                        datalabels: {
                            display: App.config.showLabels,
                            color: '#fff',
                            anchor: 'end', align: 'top',
                            font: { weight: 'bold', size: 10 },
                            formatter: (val) => val > 1000 ? (val/1000).toFixed(1)+'k' : val
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155', borderWidth: 1
                        }
                    },
                    scales: {
                        x: { 
                            display: !['pie','doughnut','radar'].includes(App.config.type),
                            grid: { color: '#1e293b' }, ticks: { color: '#64748b' },
                            stacked: App.config.stack
                        },
                        y: { 
                            display: !['pie','doughnut','radar'].includes(App.config.type),
                            grid: { color: '#1e293b' }, ticks: { color: '#64748b' },
                            stacked: App.config.stack
                        }
                    }
                }
            });

            // Update Header Text
            document.getElementById('chart-title').innerText = App.config.yKeys.length > 0 
                ? `${App.config.yKeys.join(' & ')} Analysis` 
                : 'Select Y-Axis Columns';
            document.getElementById('chart-subtitle').innerText = `Grouped by ${App.config.xKey}`;
        }

        // --- 9. TABLE VIEW ---
        function renderTable() {
            const f = App.files[App.activeFile];
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            thead.innerHTML = f.headers.map(h => `<th class="px-4 py-3 bg-slate-900 border-b border-slate-700">${h}</th>`).join('');
            
            // Limit to 100 rows for performance
            const previewRows = f.data.slice(0, 100);
            tbody.innerHTML = previewRows.map(row => `
                <tr class="hover:bg-slate-800 transition">
                    ${f.headers.map(h => `<td class="px-4 py-2 border-b border-slate-800 text-slate-400">${row[h] || ''}</td>`).join('')}
                </tr>
            `).join('');
            
            document.getElementById('row-count').innerText = `Showing 100 of ${f.data.length} rows`;
        }

        function toggleTable() {
            const p = els.tablePanel;
            p.style.height = p.style.height === '300px' ? '0px' : '300px';
        }

        // --- 10. SAVING & EXPORT ---
        async function saveState() {
            els.saveStatus.style.opacity = '1';
            await dbOp('put', 'appState', {
                files: App.files,
                activeFile: App.activeFile,
                config: App.config
            });
            setTimeout(() => els.saveStatus.style.opacity = '0', 2000);
        }

        function clearAllData() {
            if(confirm("Delete all data and reset?")) {
                dbOp('clear');
                location.reload();
            }
        }

        function downloadChart() {
            const a = document.createElement('a');
            a.download = `Analysis_${new Date().toISOString().slice(0,10)}.png`;
            a.href = App.chartInstance.toBase64Image();
            a.click();
        }

        // Prevent closing dropdown when clicking inside it
        els.yDropdown.addEventListener('click', (e) => e.stopPropagation());

    </script>
</body>
</html>
