<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataViz Pro | Multi-File Analytics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Smooth Transitions */
        .transition-all { transition: all 0.3s ease-in-out; }
        
        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-container-large { height: 65vh; min-height: 500px; }
        .chart-container-split { height: 50vh; min-height: 400px; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-700 h-16 flex items-center justify-between px-6 z-20 shadow-lg">
        <div class="flex items-center gap-4">
            <div class="bg-blue-600 text-white font-bold p-2 rounded-lg shadow-blue-500/20 shadow-lg">
                <i class="fa-solid fa-chart-line"></i>
            </div>
            <h1 class="text-lg font-bold tracking-wide">DataViz <span class="text-blue-500">Pro</span></h1>
            
            <div class="h-6 w-px bg-slate-700 mx-2"></div>

            <div id="file-tabs" class="flex gap-2 overflow-x-auto max-w-xl no-scrollbar">
                <span class="text-xs text-slate-500 italic py-2">No files loaded</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center gap-2 shadow-lg shadow-blue-600/20">
                <i class="fa-solid fa-cloud-arrow-up"></i> Upload Files
                <input type="file" id="file-input" multiple accept=".xlsx, .xls, .csv" class="hidden">
            </label>

            <div class="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg border border-slate-700">
                <span class="text-xs font-medium text-slate-400 px-2">Single</span>
                <button id="compare-toggle" class="w-10 h-5 bg-slate-600 rounded-full relative transition-colors focus:outline-none">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform transform"></div>
                </button>
                <span class="text-xs font-medium text-slate-400 px-2">Compare</span>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col md:flex-row h-[calc(100vh-64px)] overflow-hidden">
        
        <div id="viz-area" class="flex-grow flex flex-col overflow-y-auto p-4 gap-4 transition-all w-full">
            
            <div id="single-view" class="flex flex-col gap-4 h-full">
                <div class="glass-panel p-4 rounded-xl flex flex-wrap gap-4 items-end justify-between">
                    <div class="flex gap-4 items-end flex-grow">
                        <div class="w-48">
                            <label class="text-xs text-slate-400 font-semibold uppercase mb-1 block">Active Data Source</label>
                            <select id="s-file-select" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option>Upload a file first...</option>
                            </select>
                        </div>
                        <div class="w-40">
                            <label class="text-xs text-slate-400 font-semibold uppercase mb-1 block">X-Axis (Label)</label>
                            <select id="s-xaxis" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm outline-none"></select>
                        </div>
                        <div class="w-40">
                            <label class="text-xs text-slate-400 font-semibold uppercase mb-1 block">Y-Axis (Value)</label>
                            <select id="s-yaxis" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm outline-none"></select>
                        </div>
                        <div class="w-32">
                            <label class="text-xs text-slate-400 font-semibold uppercase mb-1 block">Chart Type</label>
                            <select id="s-type" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-sm outline-none">
                                <option value="bar">Bar</option>
                                <option value="line">Line</option>
                                <option value="pie">Pie</option>
                                <option value="doughnut">Doughnut</option>
                                <option value="scatter">Scatter</option>
                                <option value="radar">Radar</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="downloadChart('s-chart')" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded text-sm font-medium border border-slate-600">
                            <i class="fa-solid fa-download mr-2"></i> PNG
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-4 flex-grow relative chart-container-large">
                    <canvas id="s-chart"></canvas>
                </div>

                <div class="glass-panel rounded-xl p-0 flex flex-col h-64 overflow-hidden border-t-4 border-blue-600">
                    <div class="bg-slate-800 p-2 px-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-semibold text-sm text-slate-300">Data Spreadsheet View</h3>
                        <span id="s-row-count" class="text-xs text-slate-500">0 rows</span>
                    </div>
                    <div class="overflow-auto flex-grow p-0">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-900 text-xs uppercase sticky top-0 z-10 text-slate-300">
                                <tr id="s-table-head"></tr>
                            </thead>
                            <tbody id="s-table-body" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="compare-view" class="hidden flex-row gap-4 h-full">
                
                <div class="w-1/2 flex flex-col gap-3">
                    <div class="glass-panel p-3 rounded-lg border-l-4 border-blue-500">
                        <div class="flex gap-2 mb-2">
                            <select id="c1-file" class="bg-slate-800 text-xs w-full p-2 rounded border border-slate-600"></select>
                            <select id="c1-type" class="bg-slate-800 text-xs w-24 p-2 rounded border border-slate-600">
                                <option value="bar">Bar</option> <option value="line">Line</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <select id="c1-xaxis" class="bg-slate-800 text-xs w-1/2 p-2 rounded border border-slate-600"></select>
                            <select id="c1-yaxis" class="bg-slate-800 text-xs w-1/2 p-2 rounded border border-slate-600"></select>
                        </div>
                    </div>
                    <div class="glass-panel rounded-lg p-2 flex-grow relative chart-container-split">
                        <canvas id="c1-chart"></canvas>
                        <button onclick="downloadChart('c1-chart')" class="absolute top-2 right-2 bg-slate-800/80 p-1 px-2 rounded text-xs hover:bg-white hover:text-black transition"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>

                <div class="w-1/2 flex flex-col gap-3">
                    <div class="glass-panel p-3 rounded-lg border-l-4 border-emerald-500">
                        <div class="flex gap-2 mb-2">
                            <select id="c2-file" class="bg-slate-800 text-xs w-full p-2 rounded border border-slate-600"></select>
                            <select id="c2-type" class="bg-slate-800 text-xs w-24 p-2 rounded border border-slate-600">
                                <option value="bar">Bar</option> <option value="line">Line</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <select id="c2-xaxis" class="bg-slate-800 text-xs w-1/2 p-2 rounded border border-slate-600"></select>
                            <select id="c2-yaxis" class="bg-slate-800 text-xs w-1/2 p-2 rounded border border-slate-600"></select>
                        </div>
                    </div>
                    <div class="glass-panel rounded-lg p-2 flex-grow relative chart-container-split">
                        <canvas id="c2-chart"></canvas>
                        <button onclick="downloadChart('c2-chart')" class="absolute top-2 right-2 bg-slate-800/80 p-1 px-2 rounded text-xs hover:bg-white hover:text-black transition"><i class="fa-solid fa-download"></i></button>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <div id="welcome-overlay" class="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-lg text-center border border-slate-700">
            <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                <i class="fa-solid fa-rocket text-white"></i>
            </div>
            <h2 class="text-3xl font-bold text-white mb-2">Ready to Visualize?</h2>
            <p class="text-slate-400 mb-8">Upload multiple Excel or CSV files. Compare data side-by-side. Export professional charts instantly.</p>
            <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl text-lg font-bold transition shadow-xl shadow-blue-600/30 inline-block">
                Select Data Files
                <input type="file" id="intro-file-input" multiple accept=".xlsx, .xls, .csv" class="hidden">
            </label>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const AppState = {
            files: {}, // format: { 'filename': { data: [], headers: [] } }
            activeFile: null,
            isCompareMode: false,
            charts: {
                single: null,
                compare1: null,
                compare2: null
            }
        };

        // --- DOM ELEMENTS ---
        const els = {
            fileInput: document.getElementById('file-input'),
            introInput: document.getElementById('intro-file-input'),
            tabs: document.getElementById('file-tabs'),
            welcome: document.getElementById('welcome-overlay'),
            
            // Views
            singleView: document.getElementById('single-view'),
            compareView: document.getElementById('compare-view'),
            compareToggle: document.getElementById('compare-toggle'),
            
            // Single View Controls
            sFile: document.getElementById('s-file-select'),
            sX: document.getElementById('s-xaxis'),
            sY: document.getElementById('s-yaxis'),
            sType: document.getElementById('s-type'),
            sTableHead: document.getElementById('s-table-head'),
            sTableBody: document.getElementById('s-table-body'),
            sRowCount: document.getElementById('s-row-count'),

            // Compare View Controls
            c1File: document.getElementById('c1-file'),
            c1X: document.getElementById('c1-xaxis'),
            c1Y: document.getElementById('c1-yaxis'),
            c1Type: document.getElementById('c1-type'),

            c2File: document.getElementById('c2-file'),
            c2X: document.getElementById('c2-xaxis'),
            c2Y: document.getElementById('c2-yaxis'),
            c2Type: document.getElementById('c2-type'),
        };

        // --- EVENT LISTENERS ---
        els.fileInput.addEventListener('change', handleUpload);
        els.introInput.addEventListener('change', handleUpload);
        
        // Single View Listeners
        els.sFile.addEventListener('change', (e) => switchActiveFile(e.target.value));
        els.sX.addEventListener('change', updateSingleChart);
        els.sY.addEventListener('change', updateSingleChart);
        els.sType.addEventListener('change', updateSingleChart);

        // Compare View Listeners (Independent)
        els.c1File.addEventListener('change', () => updateComparePanel(1, true));
        els.c1X.addEventListener('change', () => updateComparePanel(1, false));
        els.c1Y.addEventListener('change', () => updateComparePanel(1, false));
        els.c1Type.addEventListener('change', () => updateComparePanel(1, false));

        els.c2File.addEventListener('change', () => updateComparePanel(2, true));
        els.c2X.addEventListener('change', () => updateComparePanel(2, false));
        els.c2Y.addEventListener('change', () => updateComparePanel(2, false));
        els.c2Type.addEventListener('change', () => updateComparePanel(2, false));

        // Toggle Mode
        els.compareToggle.addEventListener('click', toggleCompareMode);

        // --- FILE HANDLING ---
        function handleUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            els.welcome.style.display = 'none';

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });

                    if (jsonData.length > 0) {
                        const headers = Object.keys(jsonData[0]);
                        AppState.files[file.name] = { data: jsonData, headers: headers };
                        
                        // Set active if first
                        if (!AppState.activeFile) AppState.activeFile = file.name;
                        
                        refreshUI();
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function refreshUI() {
            renderFileTabs();
            populateFileSelects();
            
            // Trigger logic for Single View
            if (AppState.activeFile) {
                // Populate column dropdowns for Single view based on Active File
                populateColumnSelects(els.sX, els.sY, AppState.activeFile);
                autoGuessColumns(els.sX, els.sY, AppState.activeFile);
                renderTable(AppState.activeFile);
                updateSingleChart();
            }

            // Trigger logic for Compare View (defaults)
            const fileNames = Object.keys(AppState.files);
            if (fileNames.length > 0) {
                // Populate Compare Panel 1 (Default to first file)
                if(!els.c1File.value) {
                    populateColumnSelects(els.c1X, els.c1Y, fileNames[0]);
                    autoGuessColumns(els.c1X, els.c1Y, fileNames[0]);
                    updateComparePanel(1, false);
                }
                // Populate Compare Panel 2 (Default to second file if exists, else first)
                if(!els.c2File.value) {
                    const secondFile = fileNames[1] || fileNames[0];
                    populateColumnSelects(els.c2X, els.c2Y, secondFile);
                    autoGuessColumns(els.c2X, els.c2Y, secondFile);
                    updateComparePanel(2, false);
                }
            }
        }

        function renderFileTabs() {
            els.tabs.innerHTML = '';
            Object.keys(AppState.files).forEach(fname => {
                const isActive = fname === AppState.activeFile;
                const tab = document.createElement('div');
                tab.className = `px-3 py-1.5 rounded-md text-xs font-medium cursor-pointer whitespace-nowrap transition border ${isActive ? 'bg-blue-600/20 text-blue-400 border-blue-500/50' : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700'}`;
                tab.innerText = fname;
                tab.onclick = () => switchActiveFile(fname);
                els.tabs.appendChild(tab);
            });
        }

        function populateFileSelects() {
            const files = Object.keys(AppState.files);
            const selects = [els.sFile, els.c1File, els.c2File];
            
            selects.forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = '';
                files.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f;
                    opt.text = f;
                    sel.appendChild(opt);
                });
                if(currentVal && files.includes(currentVal)) sel.value = currentVal;
            });

            // Sync single view select with state
            if(AppState.activeFile) els.sFile.value = AppState.activeFile;
        }

        function switchActiveFile(filename) {
            AppState.activeFile = filename;
            refreshUI(); // Re-render table and single charts
        }

        function populateColumnSelects(xEl, yEl, filename) {
            if(!AppState.files[filename]) return;
            const headers = AppState.files[filename].headers;
            
            xEl.innerHTML = '';
            yEl.innerHTML = '';

            headers.forEach(h => {
                xEl.add(new Option(h, h));
                yEl.add(new Option(h, h));
            });
        }

        function autoGuessColumns(xEl, yEl, filename) {
             if(!AppState.files[filename]) return;
            const headers = AppState.files[filename].headers;
            let labelCol = headers[0];
            let valCol = headers[1] || headers[0];

            headers.forEach(h => {
                const l = h.toLowerCase();
                if (l.includes('date') || l.includes('name') || l.includes('year') || l.includes('month')) labelCol = h;
                if (l.includes('sales') || l.includes('profit') || l.includes('cost') || l.includes('amount') || l.includes('score')) valCol = h;
            });

            xEl.value = labelCol;
            yEl.value = valCol;
        }

        // --- CHARTING LOGIC ---

        function updateSingleChart() {
            if (!AppState.activeFile) return;
            renderChartGeneric(
                's-chart', 
                'single', 
                AppState.activeFile, 
                els.sX.value, 
                els.sY.value, 
                els.sType.value
            );
        }

        function updateComparePanel(panelNum, fileChanged) {
            const fileEl = panelNum === 1 ? els.c1File : els.c2File;
            const xEl = panelNum === 1 ? els.c1X : els.c2X;
            const yEl = panelNum === 1 ? els.c1Y : els.c2Y;
            const typeEl = panelNum === 1 ? els.c1Type : els.c2Type;
            const chartKey = panelNum === 1 ? 'compare1' : 'compare2';
            const canvasId = panelNum === 1 ? 'c1-chart' : 'c2-chart';

            const filename = fileEl.value;
            if(!filename) return;

            if (fileChanged) {
                populateColumnSelects(xEl, yEl, filename);
                autoGuessColumns(xEl, yEl, filename);
            }

            renderChartGeneric(canvasId, chartKey, filename, xEl.value, yEl.value, typeEl.value);
        }

        function renderChartGeneric(canvasId, storageKey, filename, xCol, yCol, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const rawData = AppState.files[filename].data;
            
            const labels = rawData.map(r => r[xCol]);
            const data = rawData.map(r => {
                let val = r[yCol];
                if (typeof val === 'string') val = parseFloat(val.replace(/[^0-9.-]+/g,""));
                return val || 0;
            });

            if (AppState.charts[storageKey]) AppState.charts[storageKey].destroy();

            const colors = generateColors(data.length);
            const isLine = type === 'line' || type === 'radar' || type === 'scatter';

            // Dataset Configuration
            let datasets = [{
                label: yCol,
                data: type === 'scatter' ? labels.map((l, i) => ({x: l, y: data[i]})) : data,
                backgroundColor: isLine ? 'rgba(59, 130, 246, 0.2)' : colors.bg,
                borderColor: isLine ? '#3b82f6' : colors.border,
                borderWidth: 1.5,
                fill: type === 'line' || type === 'radar',
                pointBackgroundColor: '#3b82f6',
                pointRadius: 4
            }];

            AppState.charts[storageKey] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } },
                        title: { display: true, text: `${filename}: ${yCol} vs ${xCol}`, color: '#e2e8f0' }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#64748b' }, 
                            grid: { color: '#1e293b' },
                            display: type !== 'pie' && type !== 'doughnut' && type !== 'radar'
                        },
                        y: { 
                            ticks: { color: '#64748b' }, 
                            grid: { color: '#1e293b' },
                            display: type !== 'pie' && type !== 'doughnut' && type !== 'radar'
                        }
                    }
                }
            });
        }

        // --- TABLE LOGIC ---
        function renderTable(filename) {
            const fileData = AppState.files[filename];
            if(!fileData) return;

            els.sTableHead.innerHTML = fileData.headers.map(h => `<th class="px-4 py-3 whitespace-nowrap bg-slate-900">${h}</th>`).join('');
            
            // Render first 200 rows for performance
            const rowsToRender = fileData.data.slice(0, 200);
            els.sTableBody.innerHTML = rowsToRender.map(row => 
                `<tr class="hover:bg-slate-800 transition">
                    ${fileData.headers.map(h => `<td class="px-4 py-2 border-b border-slate-800 truncate max-w-xs">${row[h] || ''}</td>`).join('')}
                </tr>`
            ).join('');
            
            els.sRowCount.innerText = `Displaying ${rowsToRender.length} of ${fileData.data.length} rows`;
        }

        // --- UTILS ---
        function toggleCompareMode() {
            AppState.isCompareMode = !AppState.isCompareMode;
            const toggleBtn = els.compareToggle.querySelector('div');
            
            if (AppState.isCompareMode) {
                toggleBtn.classList.add('translate-x-5');
                els.compareToggle.classList.replace('bg-slate-600', 'bg-blue-600');
                els.singleView.classList.replace('flex', 'hidden');
                els.compareView.classList.replace('hidden', 'flex');
                
                // Refresh compare charts
                updateComparePanel(1, false);
                updateComparePanel(2, false);
            } else {
                toggleBtn.classList.remove('translate-x-5');
                els.compareToggle.classList.replace('bg-blue-600', 'bg-slate-600');
                els.singleView.classList.replace('hidden', 'flex');
                els.compareView.classList.replace('flex', 'hidden');
                
                // Refresh single chart
                updateSingleChart();
            }
        }

        function downloadChart(canvasId) {
            const link = document.createElement('a');
            link.download = `chart-export-${Date.now()}.png`;
            link.href = document.getElementById(canvasId).toDataURL('image/png', 1.0);
            link.click();
        }

        function generateColors(count) {
            const bg = [], border = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137.508) % 360; // Golden angle approx
                bg.push(`hsla(${hue}, 70%, 60%, 0.6)`);
                border.push(`hsla(${hue}, 70%, 60%, 1)`);
            }
            return { bg, border };
        }
    </script>
</body>
</html>
