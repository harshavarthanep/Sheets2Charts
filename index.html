<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataViz | Professional Excel Visualizer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar for Table */
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .table-container::-webkit-scrollbar-track { background: #1f2937; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <nav class="border-b border-gray-800 bg-gray-950 py-4 px-6 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white">D</div>
            <span class="text-xl font-semibold tracking-tight">DataViz Tool</span>
        </div>
        <div class="text-sm text-gray-500">Client-Side Secure &bull; v1.0</div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-6xl">
        
        <div id="upload-section" class="mb-8">
            <div class="border-2 border-dashed border-gray-700 bg-gray-800/50 rounded-xl p-10 text-center hover:border-blue-500 transition-colors cursor-pointer relative" id="drop-zone">
                <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="space-y-2 pointer-events-none">
                    <svg class="w-12 h-12 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="text-lg font-medium text-gray-300">Drop your Excel file here</p>
                    <p class="text-sm text-gray-500">or click to browse (.xlsx, .xls)</p>
                </div>
            </div>
        </div>

        <div id="dashboard" class="hidden space-y-6">
            
            <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">X-Axis (Labels)</label>
                    <select id="x-axis-select" class="w-full bg-gray-900 border border-gray-700 text-gray-200 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option>Select Column...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Y-Axis (Values)</label>
                    <select id="y-axis-select" class="w-full bg-gray-900 border border-gray-700 text-gray-200 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option>Select Column...</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Chart Type</label>
                    <div class="flex bg-gray-900 rounded border border-gray-700 overflow-hidden">
                        <button onclick="updateChartType('bar')" class="flex-1 py-2 text-sm hover:bg-gray-700 focus:bg-blue-600 transition">Bar</button>
                        <button onclick="updateChartType('line')" class="flex-1 py-2 text-sm hover:bg-gray-700 focus:bg-blue-600 transition">Line</button>
                        <button onclick="updateChartType('pie')" class="flex-1 py-2 text-sm hover:bg-gray-700 focus:bg-blue-600 transition">Pie</button>
                    </div>
                </div>

                <div>
                    <button id="visualize-btn" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded text-sm px-5 py-2.5 focus:outline-none transition-colors shadow-lg shadow-blue-500/30">
                        Update Visual
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-gray-800 rounded-lg shadow-md border border-gray-700 p-4 relative h-96">
                    <canvas id="mainChart"></canvas>
                </div>

                <div class="bg-gray-800 rounded-lg shadow-md border border-gray-700 p-4 flex flex-col h-96">
                    <h3 class="text-sm font-semibold text-gray-300 mb-3 uppercase tracking-wider">Data Preview</h3>
                    <div class="table-container overflow-auto flex-grow border border-gray-700 rounded bg-gray-900">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-950 sticky top-0">
                                <tr id="table-head"></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 text-right" id="row-count"></div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Global State
        let rawData = [];
        let chartInstance = null;
        let currentChartType = 'bar';

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const dashboard = document.getElementById('dashboard');
        const xSelect = document.getElementById('x-axis-select');
        const ySelect = document.getElementById('y-axis-select');
        const visualizeBtn = document.getElementById('visualize-btn');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const rowCount = document.getElementById('row-count');

        // Event Listener: File Upload
        fileInput.addEventListener('change', handleFile);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    rawData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (rawData.length === 0) {
                        alert("File appears empty!");
                        return;
                    }

                    // Success: Show Dashboard
                    dashboard.classList.remove('hidden');
                    populateControls();
                    renderTablePreview();
                    
                    // Auto-guess columns and render initial chart
                    autoSelectColumns();
                    renderChart();

                } catch (error) {
                    console.error(error);
                    alert("Error parsing file. Please ensure it's a valid Excel file.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Populate Dropdowns based on Excel Headers
        function populateControls() {
            const headers = Object.keys(rawData[0]);
            
            xSelect.innerHTML = '';
            ySelect.innerHTML = '';

            headers.forEach(header => {
                const option1 = document.createElement('option');
                option1.value = header;
                option1.text = header;
                xSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = header;
                option2.text = header;
                ySelect.appendChild(option2);
            });
        }

        // Render Data Preview Table (First 20 rows)
        function renderTablePreview() {
            const headers = Object.keys(rawData[0]);
            
            // Header
            tableHead.innerHTML = headers.map(h => `<th class="px-4 py-2 whitespace-nowrap">${h}</th>`).join('');

            // Body
            tableBody.innerHTML = rawData.slice(0, 50).map(row => {
                return `<tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    ${headers.map(h => `<td class="px-4 py-2 truncate max-w-xs">${row[h]}</td>`).join('')}
                </tr>`;
            }).join('');

            rowCount.innerText = `Showing first 50 of ${rawData.length} rows`;
        }

        // Logic to guess which columns are Labels vs Numbers
        function autoSelectColumns() {
            const headers = Object.keys(rawData[0]);
            let labelCol = headers[0];
            let valueCol = headers[1] || headers[0];

            // Simple heuristic: Try to find a column with "date", "name" for X, and "amount", "price", "count" for Y
            for (let h of headers) {
                const lower = h.toLowerCase();
                if (lower.includes('date') || lower.includes('name') || lower.includes('month')) labelCol = h;
                if (lower.includes('sales') || lower.includes('amount') || lower.includes('total') || lower.includes('price')) valueCol = h;
            }

            xSelect.value = labelCol;
            ySelect.value = valueCol;
        }

        // Chart Rendering Logic
        function renderChart() {
            const xCol = xSelect.value;
            const yCol = ySelect.value;

            const labels = rawData.map(row => row[xCol]);
            const dataValues = rawData.map(row => {
                // Clean data: remove currency symbols, commas, convert to float
                let val = row[yCol];
                if (typeof val === 'string') {
                    val = parseFloat(val.replace(/[^0-9.-]+/g,""));
                }
                return val || 0;
            });

            // Destroy old chart if exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // Generate some nice colors
            const colors = generateColors(dataValues.length);

            chartInstance = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: yCol,
                        data: dataValues,
                        backgroundColor: currentChartType === 'line' ? 'rgba(59, 130, 246, 0.2)' : colors.bg,
                        borderColor: currentChartType === 'line' ? '#3b82f6' : colors.border,
                        borderWidth: 1,
                        tension: 0.3,
                        fill: currentChartType === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#9ca3af' }
                        },
                        title: {
                            display: true,
                            text: `${yCol} by ${xCol}`,
                            color: '#e5e7eb',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' },
                            display: currentChartType !== 'pie' && currentChartType !== 'doughnut'
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' },
                            display: currentChartType !== 'pie' && currentChartType !== 'doughnut'
                        }
                    }
                }
            });
        }

        // Helper: Generate dynamic colors
        function generateColors(count) {
            const bg = [];
            const border = [];
            // Tailwind-ish Palette
            const palette = [
                'rgba(59, 130, 246, 0.6)', // Blue
                'rgba(16, 185, 129, 0.6)', // Green
                'rgba(245, 158, 11, 0.6)', // Amber
                'rgba(239, 68, 68, 0.6)',  // Red
                'rgba(139, 92, 246, 0.6)', // Purple
                'rgba(236, 72, 153, 0.6)', // Pink
            ];
            const borderPalette = [
                'rgb(59, 130, 246)', 
                'rgb(16, 185, 129)', 
                'rgb(245, 158, 11)', 
                'rgb(239, 68, 68)', 
                'rgb(139, 92, 246)', 
                'rgb(236, 72, 153)', 
            ];
            
            for (let i = 0; i < count; i++) {
                bg.push(palette[i % palette.length]);
                border.push(borderPalette[i % borderPalette.length]);
            }
            return { bg, border };
        }

        // Update Chart Type Button Logic
        window.updateChartType = (type) => {
            currentChartType = type;
            renderChart();
        }

        // Manual Update Trigger
        visualizeBtn.addEventListener('click', renderChart);

    </script>
</body>
</html>
